<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMDB Data Collector - Browser Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-label {
            color: #666;
            font-weight: 500;
        }

        .status-value {
            color: #333;
            font-weight: 600;
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-info {
            color: #4fc3f7;
        }

        .log-success {
            color: #66bb6a;
        }

        .log-warning {
            color: #ffa726;
        }

        .log-error {
            color: #ef5350;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸŽ¬ TMDB Data Collector</h1>
        <p class="subtitle">Browser-based movie data collection for StreamSage</p>

        <div class="status-card">
            <div class="status-row">
                <span class="status-label">Status:</span>
                <span class="status-value" id="status">Ready to start</span>
            </div>
            <div class="status-row">
                <span class="status-label">Current Stage:</span>
                <span class="status-value" id="stage">Idle</span>
            </div>
            <div class="status-row">
                <span class="status-label">Elapsed Time:</span>
                <span class="status-value" id="elapsed">00:00:00</span>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-label">
                <span>Overall Progress</span>
                <span id="overall-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress" style="width: 0%">
                    <span id="overall-text">0 / 0</span>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-label">
                <span id="current-stage-label">Current Stage</span>
                <span id="stage-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="stage-progress" style="width: 0%">
                    <span id="stage-text">0 / 0</span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="movies-collected">0</div>
                <div class="stat-label">Movies Collected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="api-calls">0</div>
                <div class="stat-label">API Calls Made</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errors">0</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="start-btn" onclick="startCollection()">Start Collection</button>
            <button class="btn-secondary" id="pause-btn" onclick="pauseCollection()" disabled>Pause</button>
            <button class="btn-success" id="download-btn" onclick="downloadData()" disabled>Download Data</button>
        </div>

        <div class="log-container" id="log-container">
            <div class="log-entry log-info">Ready to collect TMDB movie data...</div>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = '626d6c744ce54f356ec6ce2d0ff3b6e6';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const RATE_LIMIT_DELAY = 250; // 0.25 seconds

        // Collection parameters
        const COLLECTION_PARAMS = {
            numPopularPages: 250,  // 5000 movies
            numGenrePages: 25,     // 500 per genre
            genres: {
                28: "Action", 12: "Adventure", 16: "Animation", 35: "Comedy",
                80: "Crime", 99: "Documentary", 18: "Drama", 10751: "Family",
                14: "Fantasy", 36: "History", 27: "Horror", 10402: "Music",
                9648: "Mystery", 10749: "Romance", 878: "Science Fiction",
                10770: "TV Movie", 53: "Thriller", 10752: "War", 37: "Western"
            }
        };

        // State
        let state = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            movieIds: new Set(),
            completeMovies: {},
            apiCalls: 0,
            errors: 0,
            currentStage: '',
            stageProgress: { current: 0, total: 0 }
        };

        // Logging
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            // Update stage progress
            if (state.stageProgress.total > 0) {
                const percent = Math.floor((state.stageProgress.current / state.stageProgress.total) * 100);
                document.getElementById('stage-progress').style.width = `${percent}%`;
                document.getElementById('stage-percent').textContent = `${percent}%`;
                document.getElementById('stage-text').textContent =
                    `${state.stageProgress.current} / ${state.stageProgress.total}`;
            }

            // Update overall progress
            const totalSteps = COLLECTION_PARAMS.numPopularPages +
                (Object.keys(COLLECTION_PARAMS.genres).length * COLLECTION_PARAMS.numGenrePages) +
                state.movieIds.size;
            const completedSteps = state.stageProgress.current;
            if (totalSteps > 0) {
                const overallPercent = Math.floor((completedSteps / totalSteps) * 100);
                document.getElementById('overall-progress').style.width = `${overallPercent}%`;
                document.getElementById('overall-percent').textContent = `${overallPercent}%`;
                document.getElementById('overall-text').textContent =
                    `${completedSteps} / ${totalSteps}`;
            }
        }

        // API request with retry
        async function makeRequest(endpoint, params = {}) {
            params.api_key = API_KEY;
            const url = new URL(`${BASE_URL}/${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

            try {
                await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));
                const response = await fetch(url);
                state.apiCalls++;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                state.errors++;
                log(`Error fetching ${endpoint}: ${error.message}`, 'error');
                return null;
            }
        }

        // Collect popular movies
        async function collectPopularMovies() {
            state.currentStage = 'Collecting popular movies';
            state.stageProgress = { current: 0, total: COLLECTION_PARAMS.numPopularPages };
            log('Starting popular movies collection...', 'info');

            for (let page = 1; page <= COLLECTION_PARAMS.numPopularPages; page++) {
                if (!state.isRunning || state.isPaused) break;

                const data = await makeRequest('movie/popular', { page, language: 'en-US' });
                if (data && data.results) {
                    // Filter for English original language
                    const englishMovies = data.results.filter(m => m.original_language === 'en');
                    englishMovies.forEach(movie => state.movieIds.add(movie.id));
                }

                state.stageProgress.current = page;
                updateUI();
            }

            log(`Collected ${state.movieIds.size} popular movie IDs`, 'success');
        }

        // Collect movies by genre
        async function collectGenreMovies() {
            state.currentStage = 'Collecting movies by genre';
            const totalPages = Object.keys(COLLECTION_PARAMS.genres).length * COLLECTION_PARAMS.numGenrePages;
            state.stageProgress = { current: 0, total: totalPages };

            for (const [genreId, genreName] of Object.entries(COLLECTION_PARAMS.genres)) {
                if (!state.isRunning || state.isPaused) break;

                log(`Collecting ${genreName} movies...`, 'info');

                for (let page = 1; page <= COLLECTION_PARAMS.numGenrePages; page++) {
                    if (!state.isRunning || state.isPaused) break;

                    const data = await makeRequest('discover/movie', {
                        with_genres: genreId,
                        sort_by: 'popularity.desc',
                        'vote_count.gte': 50,
                        'primary_release_date.gte': '1970-01-01',
                        'primary_release_date.lte': '2024-12-31',
                        with_original_language: 'en',
                        page
                    });

                    if (data && data.results) {
                        data.results.forEach(movie => state.movieIds.add(movie.id));
                    }

                    state.stageProgress.current++;
                    updateUI();
                }
            }

            log(`Total unique movie IDs: ${state.movieIds.size}`, 'success');
        }

        // Collect complete movie data
        async function collectCompleteMovieData() {
            state.currentStage = 'Collecting complete movie data';
            const movieIdArray = Array.from(state.movieIds);
            state.stageProgress = { current: 0, total: movieIdArray.length };

            log(`Collecting detailed data for ${movieIdArray.length} movies...`, 'info');

            for (const movieId of movieIdArray) {
                if (!state.isRunning || state.isPaused) break;

                // Skip if already collected
                if (state.completeMovies[movieId]) {
                    state.stageProgress.current++;
                    continue;
                }

                const movieData = {
                    id: movieId,
                    details: null,
                    credits: null,
                    keywords: null,
                    recommendations: null
                };

                // Get details
                movieData.details = await makeRequest(`movie/${movieId}`);
                if (!movieData.details) {
                    state.stageProgress.current++;
                    continue;
                }

                // Get credits
                movieData.credits = await makeRequest(`movie/${movieId}/credits`);

                // Get keywords
                movieData.keywords = await makeRequest(`movie/${movieId}/keywords`);

                // Get recommendations
                movieData.recommendations = await makeRequest(`movie/${movieId}/recommendations`);

                state.completeMovies[movieId] = movieData;
                state.stageProgress.current++;
                updateUI();

                // Save checkpoint every 100 movies
                if (state.stageProgress.current % 100 === 0) {
                    log(`Checkpoint: ${state.stageProgress.current} movies collected`, 'success');
                    saveCheckpoint();
                }
            }

            log(`Successfully collected data for ${Object.keys(state.completeMovies).length} movies`, 'success');
        }

        // Save checkpoint to localStorage
        function saveCheckpoint() {
            try {
                localStorage.setItem('tmdb_checkpoint', JSON.stringify({
                    movieIds: Array.from(state.movieIds),
                    completeMovies: state.completeMovies,
                    timestamp: Date.now()
                }));
                log('Checkpoint saved', 'info');
            } catch (error) {
                log('Failed to save checkpoint: ' + error.message, 'warning');
            }
        }

        // Load checkpoint from localStorage
        function loadCheckpoint() {
            try {
                const checkpoint = localStorage.getItem('tmdb_checkpoint');
                if (checkpoint) {
                    const data = JSON.parse(checkpoint);
                    state.movieIds = new Set(data.movieIds);
                    state.completeMovies = data.completeMovies;
                    log(`Loaded checkpoint: ${Object.keys(state.completeMovies).length} movies`, 'success');
                    updateUI();
                    return true;
                }
            } catch (error) {
                log('Failed to load checkpoint: ' + error.message, 'warning');
            }
            return false;
        }

        // Main collection function
        async function startCollection() {
            if (state.isRunning) return;

            state.isRunning = true;
            state.isPaused = false;
            state.startTime = Date.now();

            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            log('Starting TMDB data collection...', 'info');

            // Load checkpoint if exists
            const hasCheckpoint = loadCheckpoint();

            if (!hasCheckpoint || state.movieIds.size === 0) {
                // Stage 1: Collect popular movies
                await collectPopularMovies();

                // Stage 2: Collect genre movies
                if (state.isRunning && !state.isPaused) {
                    await collectGenreMovies();
                }
            }

            // Stage 3: Collect complete data
            if (state.isRunning && !state.isPaused) {
                await collectCompleteMovieData();
            }

            if (!state.isPaused) {
                log('Collection complete!', 'success');
                state.isRunning = false;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('download-btn').disabled = false;
            }

            updateUI();
        }

        // Pause collection
        function pauseCollection() {
            state.isPaused = true;
            state.isRunning = false;
            saveCheckpoint();
            log('Collection paused. Progress saved.', 'warning');
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            updateUI();
        }

        // Download collected data
        function downloadData() {
            const dataStr = JSON.stringify(state.completeMovies, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'movies.json';
            link.click();
            URL.revokeObjectURL(url);
            log('Data downloaded as movies.json', 'success');
        }

        // Update UI every second
        setInterval(updateUI, 1000);

        // Load checkpoint on page load
        window.addEventListener('load', () => {
            if (loadCheckpoint()) {
                document.getElementById('download-btn').disabled = false;
            }
        });
    </script>
</body>

</html>